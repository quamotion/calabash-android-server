jobs:
- job:
  pool:
    vmImage: 'ubuntu-18.04'

  container:
    image: circleci/android:api-23
    options: "-u 0 --name ci-container -v /usr/bin/docker:/tmp/docker:ro"

  steps:
  - script: |
      /tmp/docker exec -t -u 0 ci-container \
      sh -c "apt-get update && DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confold" -y install sudo"
    displayName: Set up sudo
  - task: Gradle@2
    inputs:
      workingDirectory: 'server/'
      gradleWrapperFile: 'server/gradlew'
      gradleOptions: '-Xmx3072m'
      publishJUnitResults: false
      tasks: 'assembleAndroidTest'
    displayName: "Build TestServer.apk"

  - script: |
      ls $(Build.SourcesDirectory)

  - task: CopyFiles@2
    inputs:
      sourceFolder: '$(Build.SourcesDirectory)'
      contents: '(AndroidManifest.*|TestServer.*)'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: drop